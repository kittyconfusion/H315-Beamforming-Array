% ECE315H Beam-Forming from N amount of audio inputs
% Andrew DaCruz, Nathan Williams, Jacob Zylinski
% Task 1: Process beamforming using audio recordings on MATLAB
% This matlab code processes an audio file of a real signal and performs a
% fft to provide frequency, magnitude, and phase
% 10/8/2025

clear; clf; clc;

% Import the audio 

% [y, Fs] = audioread('constant_5khz.m4a');

% x = mic 2, y = mic 1

x = [5296.00, 5313.00, 5308.00, 5280.00, 5240.00, 5272.00, 5237.00, 5240.00, 5396.00, 5320.00, 5313.00, 5204.00, 5169.00, 5236.00, 5193.00, 5281.00, 5281.00, 5292.00, 5300.00, 5097.00, 5141.00, 5088.00, 5173.00, 5220.00, 5176.00, 5181.00, 5093.00, 5181.00, 5248.00, 5152.00, 5212.00, 5153.00, 5233.00, 5224.00, 5181.00, 5264.00, 5225.00, 5300.00, 5300.00, 5284.00, 5340.00, 5289.00, 5376.00, 5341.00, 5349.00, 5377.00, 5317.00, 5421.00, 5357.00, 5337.00, 5344.00, 5233.00, 5332.00, 5216.00, 5113.00, 5229.00, 5229.00, 5409.00, 5248.00, 5309.00, 5181.00, 5164.00, 5181.00, 5080.00, 5181.00, 5237.00, 5245.00, 5348.00, 5181.00, 5244.00, 5156.00, 5212.00, 5232.00, 5212.00, 5297.00, 5289.00, 5288.00, 5280.00, 5181.00, 5285.00, 5245.00, 5265.00, 5209.00, 5212.00, 5309.00, 5249.00, 5205.00, 5181.00, 5116.00, 5268.00, 5152.00, 5212.00, 5212.00, 5213.00, 5269.00, 5161.00, 5288.00, 5321.00, 5401.00, 5441.00, 5333.00, 5405.00, 5348.00, 5416.00, 5488.00, 5452.00, 5557.00, 5412.00, 5448.00, 5421.00, 5280.00, 5284.00, 5293.00, 5413.00, 5480.00, 5345.00, 5400.00, 5233.00, 5321.00, 5181.00, 5181.00, 5261.00, 5308.00, 5376.00, 5340.00, 5257.00, 5329.00, 5220.00, 5333.00, 5236.00, 5308.00, 5356.00, 5312.00, 5384.00, 5265.00, 5280.00, 5252.00, 5205.00, 5209.00, 5181.00, 5276.00, 5300.00, 5265.00, 5305.00, 5181.00, 5224.00, 5181.00, 5181.00, 5257.00, 5240.00, 5380.00, 5353.00, 5337.00, 5357.00, 5336.00, 5449.00, 5392.00, 5397.00, 5388.00, 5353.00, 5472.00, 5352.00, 5368.00, 5365.00, 5293.00, 5404.00, 5229.00, 5241.00, 5285.00, 5277.00, 5404.00, 5297.00, 5341.00, 5316.00, 5320.00, 5329.00, 5213.00, 5268.00, 5256.00, 5296.00, 5325.00, 5181.00, 5269.00, 5233.00, 5260.00, 5245.00, 5177.00, 5261.00, 5237.00, 5240.00, 5225.00, 5181.00, 5276.00, 5220.00, 5249.00, 5253.00, 5236.00, 5320.00, 5181.00, 5264.00, 5193.00, 5181.00, 5217.00, 5088.00, 5181.00, 5156.00, 5180.00, 5236.00, 5197.00, 5228.00, 5181.00, 5241.00, 5289.00, 5248.00, 5352.00, 5308.00, 5380.00, 5392.00, 5325.00, 5421.00, 5336.00, 5429.00, 5392.00, 5333.00, 5364.00, 5229.00, 5284.00, 5181.00, 5169.00, 5212.00, 5156.00, 5221.00, 5173.00, 5173.00, 5209.00, 5160.00, 5217.00, 5172.00, 5192.00, 5237.00, 5181.00, 5272.00, 5233.00, 5297.00, 5352.00, 5325.00, 5408.00, 5316.00, 5349.00, 5340.00, 5281.00, 5340.00, 5233.00, 5285.00, 5249.00, 5220.00, 5261.00, 5169.00, 5257.00, 5216.00, 5204.00, 5245.00, 5181.00, 5304.00, 5245.00, 5276.00, 5333.00, 5304.00, 5441.00, 5344.00, 5401.00, 5421.00, 5400.00, 5480.00, 5425.00, 5465.00, 5433.00, 5380.00, 5405.00, 5329.00, 5356.00, 5284.00, 5232.00, 5252.00, 5152.00, 5216.00, 5152.00, 5181.00, 5249.00, 5236.00, 5313.00, 5221.00, 5305.00, 5300.00, 5216.00, 5285.00, 5241.00, 5292.00, 5297.00, 5249.00, 5345.00, 5264.00, 5345.00, 5325.00, 5324.00, 5369.00, 5264.00, 5309.00, 5257.00, 5229.00, 5269.00, 5197.00, 5248.00, 5217.00, 5224.00, 5240.00, 5156.00, 5228.00, 5160.00, 5220.00, 5257.00, 5209.00, 5328.00, 5301.00, 5365.00, 5417.00, 5373.00, 5469.00, 5453.00, 5488.00, 5441.00, 5409.00, 5456.00, 5365.00, 5381.00, 5284.00, 5248.00, 5281.00, 5204.00, 5205.00, 5201.00, 5205.00, 5264.00, 5181.00, 5265.00, 5224.00, 5260.00, 5281.00, 5212.00, 5325.00, 5281.00, 5348.00, 5377.00, 5365.00, 5433.00, 5357.00, 5404.00, 5369.00, 5312.00, 5353.00, 5252.00, 5301.00, 5249.00, 5224.00, 5252.00, 5156.00, 5245.00, 5181.00, 5181.00, 5216.00, 5152.00, 5217.00, 5153.00, 5172.00, 5181.00, 5152.00, 5260.00, 5216.00, 5340.00, 5349.00, 5300.00, 5401.00, 5337.00, 5396.00, 5400.00, 5377.00, 5428.00, 5332.00, 5357.00, 5273.00, 5245.00, 5236.00, 5152.00, 5208.00, 5153.00, 5168.00, 5200.00, 5101.00, 5213.00, 5160.00, 5181.00, 5213.00, 5112.00, 5212.00, 5161.00, 5252.00, 5245.00, 5216.00, 5325.00, 5265.00, 5337.00, 5325.00, 5281.00, 5321.00, 5228.00, 5293.00, 5249.00, 5268.00, 5333.00, 5252.00, 5317.00, 5248.00, 5240.00, 5237.00, 5168.00, 5264.00, 5220.00, 5256.00, 5284.00, 5265.00, 5357.00, 5288.00, 5344.00, 5336.00, 5296.00, 5400.00, 5332.00, 5409.00, 5413.00, 5393.00, 5476.00, 5408.00, 5476.00, 5452.00, 5413.00, 5440.00, 5344.00, 5361.00, 5257.00, 5260.00, 5284.00, 5212.00, 5288.00, 5221.00, 5257.00, 5281.00, 5237.00, 5301.00, 5240.00, 5284.00, 5289.00, 5268.00, 5360.00, 5280.00, 5321.00, 5312.00, 5293.00, 5365.00, 5277.00, 5345.00, 5309.00, 5304.00, 5353.00, 5281.00, 5332.00, 5305.00, 5321.00, 5352.00, 5264.00, 5340.00, 5293.00, 5332.00, 5333.00, 5268.00, 5365.00, 5277.00, 5320.00, 5313.00, 5293.00, 5405.00, 5332.00, 5400.00, 5381.00, 5365.00, 5429.00, 5317.00, 5425.00, 5393.00, 5404.00, 5445.00, 5365.00, 5420.00, 5301.00, 5297.00, 5304.00, 5216.00, 5309.00, 5253.00, 5261.00, 5336.00, 5280.00, 5293.00];
y = [5305.00, 5372.00, 5305.00, 5240.00, 5260.00, 5285.00, 5273.00, 5181.00, 5277.00, 5329.00, 5292.00, 5300.00, 5140.00, 5220.00, 5152.00, 5181.00, 5240.00, 5224.00, 5308.00, 5181.00, 5116.00, 5100.00, 5053.00, 5201.00, 5137.00, 5244.00, 5152.00, 5057.00, 5181.00, 5105.00, 5180.00, 5152.00, 5152.00, 5220.00, 5113.00, 5200.00, 5181.00, 5224.00, 5292.00, 5217.00, 5313.00, 5265.00, 5312.00, 5365.00, 5300.00, 5393.00, 5316.00, 5357.00, 5397.00, 5345.00, 5404.00, 5284.00, 5304.00, 5305.00, 5212.00, 5181.00, 5116.00, 5285.00, 5361.00, 5281.00, 5328.00, 5093.00, 5181.00, 5065.00, 5100.00, 5160.00, 5181.00, 5297.00, 5244.00, 5204.00, 5208.00, 5096.00, 5216.00, 5112.00, 5244.00, 5273.00, 5288.00, 5320.00, 5181.00, 5217.00, 5221.00, 5229.00, 5297.00, 5105.00, 5240.00, 5233.00, 5236.00, 5181.00, 5085.00, 5165.00, 5160.00, 5152.00, 5181.00, 5108.00, 5240.00, 5156.00, 5181.00, 5273.00, 5321.00, 5452.00, 5357.00, 5388.00, 5409.00, 5404.00, 5501.00, 5444.00, 5541.00, 5524.00, 5412.00, 5488.00, 5389.00, 5328.00, 5252.00, 5308.00, 5421.00, 5453.00, 5429.00, 5340.00, 5252.00, 5329.00, 5152.00, 5253.00, 5205.00, 5341.00, 5373.00, 5329.00, 5345.00, 5289.00, 5284.00, 5292.00, 5229.00, 5352.00, 5277.00, 5353.00, 5325.00, 5261.00, 5305.00, 5201.00, 5269.00, 5181.00, 5180.00, 5256.00, 5209.00, 5313.00, 5241.00, 5181.00, 5205.00, 5109.00, 5245.00, 5196.00, 5268.00, 5373.00, 5312.00, 5361.00, 5268.00, 5365.00, 5424.00, 5372.00, 5408.00, 5300.00, 5412.00, 5417.00, 5344.00, 5409.00, 5317.00, 5377.00, 5349.00, 5256.00, 5281.00, 5260.00, 5369.00, 5340.00, 5333.00, 5349.00, 5260.00, 5341.00, 5241.00, 5252.00, 5244.00, 5208.00, 5309.00, 5229.00, 5245.00, 5237.00, 5181.00, 5265.00, 5181.00, 5248.00, 5220.00, 5181.00, 5249.00, 5169.00, 5225.00, 5228.00, 5217.00, 5264.00, 5181.00, 5265.00, 5201.00, 5181.00, 5213.00, 5089.00, 5209.00, 5088.00, 5101.00, 5152.00, 5096.00, 5209.00, 5108.00, 5117.00, 5152.00, 5093.00, 5253.00, 5181.00, 5288.00, 5301.00, 5316.00, 5388.00, 5301.00, 5381.00, 5368.00, 5377.00, 5456.00, 5341.00, 5393.00, 5289.00, 5253.00, 5280.00, 5157.00, 5248.00, 5201.00, 5197.00, 5201.00, 5088.00, 5181.00, 5104.00, 5152.00, 5153.00, 5092.00, 5197.00, 5100.00, 5216.00, 5252.00, 5233.00, 5321.00, 5281.00, 5372.00, 5329.00, 5313.00, 5352.00, 5256.00, 5328.00, 5253.00, 5233.00, 5261.00, 5176.00, 5248.00, 5161.00, 5197.00, 5229.00, 5152.00, 5216.00, 5157.00, 5225.00, 5257.00, 5181.00, 5285.00, 5221.00, 5344.00, 5340.00, 5308.00, 5397.00, 5345.00, 5448.00, 5425.00, 5433.00, 5477.00, 5356.00, 5421.00, 5365.00, 5345.00, 5352.00, 5257.00, 5289.00, 5176.00, 5176.00, 5197.00, 5116.00, 5224.00, 5156.00, 5220.00, 5252.00, 5208.00, 5265.00, 5141.00, 5208.00, 5200.00, 5181.00, 5293.00, 5236.00, 5301.00, 5256.00, 5257.00, 5332.00, 5261.00, 5360.00, 5296.00, 5288.00, 5308.00, 5225.00, 5280.00, 5181.00, 5212.00, 5212.00, 5152.00, 5201.00, 5097.00, 5161.00, 5173.00, 5152.00, 5280.00, 5181.00, 5245.00, 5276.00, 5293.00, 5400.00, 5321.00, 5425.00, 5425.00, 5421.00, 5468.00, 5381.00, 5468.00, 5396.00, 5384.00, 5384.00, 5265.00, 5329.00, 5224.00, 5213.00, 5209.00, 5153.00, 5244.00, 5157.00, 5220.00, 5237.00, 5181.00, 5280.00, 5181.00, 5249.00, 5276.00, 5272.00, 5381.00, 5324.00, 5416.00, 5388.00, 5377.00, 5421.00, 5293.00, 5364.00, 5300.00, 5300.00, 5308.00, 5181.00, 5256.00, 5169.00, 5181.00, 5208.00, 5104.00, 5204.00, 5112.00, 5181.00, 5169.00, 5101.00, 5181.00, 5093.00, 5208.00, 5181.00, 5205.00, 5317.00, 5249.00, 5376.00, 5353.00, 5345.00, 5404.00, 5337.00, 5432.00, 5348.00, 5329.00, 5336.00, 5244.00, 5308.00, 5180.00, 5181.00, 5196.00, 5109.00, 5205.00, 5112.00, 5172.00, 5173.00, 5152.00, 5208.00, 5089.00, 5176.00, 5101.00, 5152.00, 5248.00, 5181.00, 5273.00, 5264.00, 5285.00, 5357.00, 5269.00, 5321.00, 5253.00, 5269.00, 5292.00, 5209.00, 5293.00, 5236.00, 5265.00, 5257.00, 5180.00, 5248.00, 5152.00, 5181.00, 5228.00, 5201.00, 5317.00, 5224.00, 5301.00, 5297.00, 5252.00, 5321.00, 5272.00, 5348.00, 5344.00, 5380.00, 5452.00, 5396.00, 5477.00, 5416.00, 5448.00, 5464.00, 5397.00, 5485.00, 5388.00, 5381.00, 5349.00, 5269.00, 5329.00, 5245.00, 5272.00, 5276.00, 5224.00, 5320.00, 5221.00, 5300.00, 5284.00, 5260.00, 5333.00, 5245.00, 5340.00, 5313.00, 5300.00, 5345.00, 5272.00, 5369.00, 5300.00, 5320.00, 5381.00, 5292.00, 5360.00, 5280.00, 5289.00, 5309.00, 5288.00, 5388.00, 5256.00, 5285.00, 5304.00, 5277.00, 5353.00, 5261.00, 5317.00, 5304.00, 5265.00, 5353.00, 5280.00, 5380.00, 5348.00, 5356.00, 5425.00, 5345.00, 5421.00, 5353.00, 5368.00, 5429.00, 5360.00, 5453.00, 5373.00, 5393.00, 5372.00, 5276.00, 5340.00, 5248.00, 5281.00, 5289.00, 5248.00, 5325.00, 5277.00, 5340.00];
Fs = 6144;

% Low pass filter

Fpass = 300;    % Hz

x = highpass(x,Fpass,Fs);
y = highpass(y,Fpass,Fs);

% extract mono channel audio (instead of stero audio)

y_mono = y;

% Definitions 

N = length(y_mono);     % number of samples
L = N/Fs;               % Length of signal (duration in s)
T = 1/Fs;               % Sampling period       
t = linspace(0,L,N);    % Time array

% Plot time-domain signal
plot(1000*t,y_mono, 1000*t, x)         
title("Signal in Time-Domain")
xlabel("t (milliseconds)")
ylabel("signal")
legend("Mic 1","Mic 2");


% Set up Fast Fourier Transform
X = fft(x);
magx = abs(X);
phasex = angle(X) * 180/pi;

Y = fft(y_mono);                % Y(f): signal in frequency domain
mag = abs(Y);                   % magnitude |Y(f)|
phase = angle(Y) * 180/pi;      % phase of Y(f), in degrees

% size of Y is same as input, so each frequency bin (index) is Fs/N (hz), 
% and indices 0:N/2 are pos frequency, N/2+1:N-1 are neg frequency

half_N = floor(N/2);            % half the samples to divide frequencies
f = (0:half_N) * (Fs/N);        % define positive frequency array
mag = mag(1:half_N+1);          % pos freq magnitude
mag(1:3)=0;
phase = phase(1:half_N+1);      % pos freq phase

magx = magx(1:half_N+1);          % pos freq magnitude
magx(1:3)=0;
phasex = phasex(1:half_N+1);      % pos freq phase

% set up data to use for beam forming

freq_mag_phase_y = [f(:), mag(:), phase(:)];
freq_mag_phase_x = [f(:), magx(:), phasex(:)];

% Find transmitting frequency

[Mmaxy,indexy] = max(freq_mag_phase_y(:,2));
f0y = freq_mag_phase_y(indexy,1);

[Mmaxx,indexx] = max(freq_mag_phase_x(:,2));
f0x = freq_mag_phase_x(indexx,1);

check_f0 = f0y-f0x;

if (check_f0 < 1)

    f0 = (f0x + f0y)/2

end

%f0 = input("Please enter transmitting frequency in hz: ");

% Setup delay

delay = 0.5 * 1/Fs;
numElements = length(phasex); 

for i = 1:numElements
    phasex(1,i) = phasex(1,i) - 2*pi*f0*delay;
end

freq_mag_phase_x = [f(:), magx(:), phasex(:)];

% Plot magnitude and phase of signal in frequency - domain

figure;
plot(f, mag, f, magx, 'LineWidth', 1.5);
title("Magnitude of Signal in Frequency Domain");
xlabel("Frequency (Hz)");
ylabel("mag");
legend("Mic 1","Mic 2");

figure;
plot(f, unwrap(phase), f, unwrap(phasex), 'LineWidth', 1.5);
title("Phase of Signal in Frequency Domain");
xlabel("Frequency (Hz)");
ylabel("< (f) (deg)");
legend("Mic 1","Mic 2");



% Set up beamforming

d = 7e-2;       % distance between microphones (m)
c = 343;        % speed of sound (m/s)

[~,indexx] = min(abs(freq_mag_phase_x(:,1) - f0));
[~,indexy] = min(abs(freq_mag_phase_y(:,1) - f0));

phi_x = freq_mag_phase_x(indexx,3) * pi/180;
phi_y = freq_mag_phase_y(indexy,3) * pi/180;

dphi = angle(exp(1j*(phi_x - phi_y)));   % delta phi, in rad, wrap [-pi,pi]

lambda = c/f0;                           % wavelength, in m
ah = lambda / (2 * pi * d) * dphi;

theta = asin(ah) * 180/pi